<!DOCTYPE html>
<html lang="en">
<head>
    <title>Wedding</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Font style -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ysabeau+Infant:ital,wght@0,1..1000;1,1..1000&display=swap"
            rel="stylesheet"
    />

    <link rel="icon" href="images/favicon.ico" type="image/x-icon"/>

    <!-- Links to the page style -->
    <link rel="stylesheet" href="style.css"/>
</head>

<body>
<!-- Navegation bar-->
<header>
    <li>
        <a href="#details">О СВАДЬБЕ</a>
    </li>

    <!--
    <li>
        <a href="#registry">REGISTRY</a>
    </li>
    -->

    <li>
        <a href="#rsvp">ПОДТВЕРЖДЕНИЕ</a>
    </li>
</header>

<!-- Initial view-->

<div class="container-title fade-in">
    <h1>Темирхан & Марина</h1>
    <h2>ИГРАЮТ СВАДЬБУ</h2>
</div>

<!-- Details - First section -->
<section class="container" id="details">
    <h3>
        Вы приглашены на нашу свадьбу <br/>
        20 сентября, 2025
    </h3>

    <p>
        Sky Hall
        <br/>
        Казахстан, Алматы
        <br/>
        ул. Кожабекова 21/1
    </p>

    <h3>Начало церемонии 18:00</h3>
    <p style="position:relative;overflow:hidden;">
        <iframe src="https://yandex.kz/map-widget/v1/?indoorLevel=1&ll=76.895010%2C43.201017&mode=search&oid=102807593836&ol=biz&z=17.84"
                width="560" height="400" allowfullscreen="true" style="border: 0;" t></iframe>
    </p>
</section>

<br/>
<br/>
<br/>

<!-- Registry - Second section  -->
<!--
<section class="container" id="registry">
    <img src="./images/couple.webp" alt="Married image"/>

    <h1>Registry</h1>

    <p>
        We are so incredibly thankful for the effort you'll be making to join us
        for our special day in (destination). Your presence is your present, so
        please, no gifts! We are lucky enough to have everything we need for
        this new chapter together, so please, no gifts required!
    </p>
</section>
-->

<br/>
<br/>
<br/>

<!-- RSVP form - Here user can send a message or confirmation-->

<form class="container-form" id="rsvp">
    <h1>Будете ли вы?</h1>

    <div class="radio-group">
        <label>
            <input type="radio" name="attendance" value="yes" id="attendYes" onchange="toggleFields()">
            <span>Обязательно буду!</span>
        </label>
        <label>
            <input type="radio" name="attendance" value="no" id="attendNo" onchange="toggleFields()">
            <span>На этот раз без меня</span>
        </label>
    </div>

    <input type="text" placeholder="Имя" required id="nameField"/>
    <div id="guestsContainer">
      <!-- Dynamic guest fields will be added here -->
    </div>
    <button type="button" id="addGuestBtn" onclick="addGuestField()">Со мной придут ещё люди</button>
    <textarea placeholder="Что-то ещё хотите добавить?" id="messageField"></textarea>
    <input type="submit" onclick="sendEmail()" value="Отправить">
</form>

<br/>
<br/>
<br/>

<script>
  /************* Form state tracking ********************/
  let formSubmitted = false;
  let currentUUID = null;
  let invitationData = null;
  let guestCounter = 0;

  /************* localStorage functions ********************/
  function saveSubmissionStatus(submitted) {
    try {
      localStorage.setItem('weddingFormSubmitted', submitted.toString());
    } catch (e) {
      console.warn('localStorage not available:', e);
    }
  }

  function loadSubmissionStatus() {
    try {
      const saved = localStorage.getItem('weddingFormSubmitted');
      return saved === 'true';
    } catch (e) {
      console.warn('localStorage not available:', e);
      return false;
    }
  }

  /************* Dynamic guest management ********************/
  function addGuestField() {
    guestCounter++;
    const guestDiv = document.createElement('div');
    guestDiv.className = 'guest-field';
    guestDiv.id = `guest-${guestCounter}`;
    guestDiv.innerHTML = `
      <input type="text" placeholder="Имя гостя" class="guest-input" 
             onpaste="preventSemicolon(event)" oninput="preventSemicolon(event)">
      <button type="button" onclick="removeGuestField(${guestCounter})">✕</button>
    `;
    document.getElementById('guestsContainer').appendChild(guestDiv);
  }

  function removeGuestField(id) {
    const guestElement = document.getElementById(`guest-${id}`);
    if (guestElement) {
      guestElement.remove();
    }
  }

  function preventSemicolon(event) {
    if (event.type === 'input') {
      // Remove semicolons from typed input
      event.target.value = event.target.value.replace(/;/g, '');
    } else if (event.type === 'paste') {
      // Prevent pasting content with semicolons
      event.preventDefault();
      const paste = (event.clipboardData || window.clipboardData).getData('text');
      const cleanPaste = paste.replace(/;/g, '');
      event.target.value = event.target.value + cleanPaste;
    }
  }

  function collectGuestData() {
    const guestInputs = document.querySelectorAll('.guest-input');
    const guests = Array.from(guestInputs)
      .map(input => input.value.trim())
      .filter(value => value.length > 0);
    return guests.join(';');
  }

  function clearAllGuestFields() {
    document.getElementById('guestsContainer').innerHTML = '';
    guestCounter = 0;
  }

  /************* Handle the data from RSVP ********************/
  async function sendEmail() {
    // Get form data
    const attendanceElement = document.querySelector('input[name="attendance"]:checked');
    const nameField = document.getElementById('nameField');
    const messageField = document.getElementById('messageField');
    
    // Validate required fields
    if (!attendanceElement) {
      alert('Пожалуйста, выберите вариант посещения');
      return;
    }
    
    // Name is only required when attending
    if (attendanceElement.value === 'yes' && !nameField.value.trim()) {
      alert('Пожалуйста, укажите ваше имя');
      return;
    }
    
    // Prepare form data
    const formData = {
      attendance: attendanceElement.value,
      name: nameField.value.trim(),
      guest: collectGuestData(),
      message: messageField.value.trim(),
      uuid: currentUUID
    };
    
    // Show loading state
    const submitButton = document.querySelector('input[type="submit"]');
    const originalText = submitButton.value;
    submitButton.value = 'Отправляем...';
    submitButton.disabled = true;
    
    try {
      // Send to Cloudflare Worker
      const response = await fetch('https://tima-wedding.xavescor.workers.dev', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show different messages based on attendance choice
        const defaultMessage = attendanceElement.value === 'yes' 
          ? 'Ответ отправлен! Спасибо за подтверждение!'
          : 'Зафиксировано что вы не придёте';
        alert(result.message || defaultMessage);
        formSubmitted = true; // Mark as submitted so no warning is shown
        saveSubmissionStatus(true); // Persist submission status to localStorage
        
        // Keep form fields populated with submitted data for better UX
        // Users can see what they submitted and modify if needed
      } else {
        alert(result.error || 'Ошибка отправки. Попробуйте еще раз.');
      }
      
    } catch (error) {
      console.error('Error submitting form:', error);
      alert('Ошибка отправки. Проверьте интернет-соединение и попробуйте еще раз.');
    } finally {
      // Restore button state
      submitButton.value = originalText;
      submitButton.disabled = false;
    }
  }

  /************* Toggle form fields based on attendance choice ********************/
  function toggleFields() {
    const attendYes = document.getElementById('attendYes');
    const nameField = document.getElementById('nameField');
    const addGuestBtn = document.getElementById('addGuestBtn');
    const messageField = document.getElementById('messageField');

    if (attendYes.checked) {
      // Enable all fields when attending
      nameField.disabled = false;
      addGuestBtn.disabled = false;
      messageField.disabled = false;
    } else {
      // Keep name field enabled when not attending
      nameField.disabled = false;
      addGuestBtn.disabled = true;
      messageField.disabled = true;

      // Clear guest fields and message when not attending
      clearAllGuestFields();
      messageField.value = '';
    }
  }

  /************* Page close prevention ********************/
  window.addEventListener('beforeunload', function(event) {
    // Only show warning if form has data and hasn't been submitted
    if (!formSubmitted) {
      const message = 'Форма ещё не отправлена. Уверены что хотите уйти?';
      event.preventDefault();
      event.returnValue = message; // For older browsers
      return message;
    }
  });

  /************* UUID validation functions ********************/
  function getUUIDFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('uuid');
  }
  
  async function validateUUID(uuid) {
    try {
      const response = await fetch(`https://tima-wedding.xavescor.workers.dev/invite/${uuid}`);
      const result = await response.json();
      return result;
    } catch (error) {
      console.error('Error validating UUID:', error);
      return { success: false, error: 'Ошибка проверки приглашения' };
    }
  }
  
  function showInvalidInvitation() {
    document.body.innerHTML = `
      <div style="max-width: 600px; margin: 100px auto; padding: 20px; text-align: center; font-family: Arial, sans-serif;">
        <h1 style="color: #ff4444;">Приглашение не найдено</h1>
        <p>Ссылка на приглашение недействительна или истекла.</p>
        <p>Обратитесь к организаторам за новым приглашением.</p>
      </div>
    `;
  }
  
  function showLoadingState() {
    document.body.style.opacity = '0.5';
    document.body.style.pointerEvents = 'none';
  }
  
  function hideLoadingState() {
    document.body.style.opacity = '1';
    document.body.style.pointerEvents = 'auto';
  }

  /************* Restore form data from invitation ********************/
  function restoreFormData(invitationData) {
    // Always display Column D (user name) in name field
    if (invitationData.name) {
      const nameField = document.getElementById('nameField');
      if (nameField) {
        nameField.value = invitationData.name;
      }
    }
    
    // Restore guest fields from semicolon-separated string
    if (invitationData.guest && invitationData.guest.trim()) {
      const guests = invitationData.guest.split(';')
        .map(guest => guest.trim())
        .filter(guest => guest.length > 0);
      
      guests.forEach(guestName => {
        addGuestField();
        const guestInputs = document.querySelectorAll('.guest-input');
        const lastInput = guestInputs[guestInputs.length - 1];
        if (lastInput) {
          lastInput.value = guestName;
        }
      });
    }
    
    // Restore message field
    if (invitationData.message) {
      const messageField = document.getElementById('messageField');
      if (messageField) {
        messageField.value = invitationData.message;
      }
    }
    
    // Set attendance radio buttons based on status
    const status = invitationData.status ? invitationData.status.trim() : '';
    
    if (status === 'Принято') {
      const attendYes = document.getElementById('attendYes');
      if (attendYes) {
        attendYes.checked = true;
        toggleFields();
      }
    } else if (status === 'Отклонено') {
      const attendNo = document.getElementById('attendNo');
      if (attendNo) {
        attendNo.checked = true;
        toggleFields();
      }
    }
  }

  /************* Initialize page state ********************/
  document.addEventListener('DOMContentLoaded', async function() {
    // Get UUID from URL
    currentUUID = getUUIDFromURL();
    
    if (!currentUUID) {
      showInvalidInvitation();
      return;
    }
    
    // Show loading state while validating
    showLoadingState();
    
    // Validate UUID
    const validation = await validateUUID(currentUUID);
    
    if (!validation.success) {
      showInvalidInvitation();
      return;
    }
    
    // Store invitation data
    invitationData = validation.invitation;
    
    // Restore form data from previous submission
    restoreFormData(invitationData);
    
    // Hide loading state
    hideLoadingState();
    
    // Load submission status from localStorage
    formSubmitted = loadSubmissionStatus();
  });
</script>
</body>
</html>
