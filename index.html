<!DOCTYPE html>
<html lang="en">
<head>
    <title>Wedding</title>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Font style -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Ysabeau+Infant:ital,wght@0,1..1000;1,1..1000&display=swap"
            rel="stylesheet"
    />

    <link rel="icon" href="images/favicon.ico" type="image/x-icon"/>

    <!-- Links to the page style -->
    <link rel="stylesheet" href="style.css"/>
</head>

<body>
<!-- Navegation bar-->
<header>
    <li>
        <a href="#details">О СВАДЬБЕ</a>
    </li>

    <!--
    <li>
        <a href="#registry">REGISTRY</a>
    </li>
    -->

    <li>
        <a href="#rsvp">ПОДТВЕРЖДЕНИЕ</a>
    </li>
</header>

<!-- Initial view-->

<div class="container-title fade-in">
    <h1>Темирхан & Марина</h1>
    <h2>ИГРАЮТ СВАДЬБУ</h2>
</div>

<!-- Details - First section -->
<section class="container" id="details">
    <h3>
        Вы приглашены на нашу свадьбу <br/>
        20 сентября, 2025
    </h3>

    <p>
        Sky Hall
        <br/>
        Казахстан, Алматы
        <br/>
        ул. Кожабекова 21/1
    </p>

    <h3>Начало церемонии 18:00</h3>
    <p style="position:relative;overflow:hidden;">
        <iframe src="https://yandex.kz/map-widget/v1/?indoorLevel=1&ll=76.895010%2C43.201017&mode=search&oid=102807593836&ol=biz&z=17.84"
                width="560" height="400" allowfullscreen="true" style="border: 0;" t></iframe>
    </p>
</section>

<br/>
<br/>
<br/>

<!-- Registry - Second section  -->
<!--
<section class="container" id="registry">
    <img src="./images/couple.webp" alt="Married image"/>

    <h1>Registry</h1>

    <p>
        We are so incredibly thankful for the effort you'll be making to join us
        for our special day in (destination). Your presence is your present, so
        please, no gifts! We are lucky enough to have everything we need for
        this new chapter together, so please, no gifts required!
    </p>
</section>
-->

<br/>
<br/>
<br/>

<!-- RSVP form - Here user can send a message or confirmation-->

<form class="container-form" id="rsvp">
    <h1>Будете ли вы?</h1>

    <div class="radio-group">
        <label>
            <input type="radio" name="attendance" value="yes" id="attendYes" onchange="toggleFields()">
            <span>Обязательно буду!</span>
        </label>
        <label>
            <input type="radio" name="attendance" value="no" id="attendNo" onchange="toggleFields()">
            <span>На этот раз без меня</span>
        </label>
    </div>

    <input type="text" placeholder="Имя" required id="nameField"/>
    <input type="text" placeholder="(Имя +1, если приведёте)" id="guestsField"/>
    <textarea placeholder="Что-то ещё хотите добавить?" id="messageField"></textarea>
    <input type="submit" onclick="sendEmail()" value="Отправить">
</form>

<br/>
<br/>
<br/>

<script>
  /************* Form state tracking ********************/
  let formSubmitted = false;

  /************* localStorage functions ********************/
  function saveSubmissionStatus(submitted) {
    try {
      localStorage.setItem('weddingFormSubmitted', submitted.toString());
    } catch (e) {
      console.warn('localStorage not available:', e);
    }
  }

  function loadSubmissionStatus() {
    try {
      const saved = localStorage.getItem('weddingFormSubmitted');
      return saved === 'true';
    } catch (e) {
      console.warn('localStorage not available:', e);
      return false;
    }
  }

  /************* Handle the data from RSVP ********************/
  async function sendEmail() {
    // Get form data
    const attendanceElement = document.querySelector('input[name="attendance"]:checked');
    const nameField = document.getElementById('nameField');
    const guestsField = document.getElementById('guestsField');
    const messageField = document.getElementById('messageField');
    
    // Validate required fields
    if (!attendanceElement) {
      alert('Пожалуйста, выберите вариант посещения');
      return;
    }
    
    // Name is only required when attending
    if (attendanceElement.value === 'yes' && !nameField.value.trim()) {
      alert('Пожалуйста, укажите ваше имя');
      return;
    }
    
    // Prepare form data
    const formData = {
      attendance: attendanceElement.value,
      name: nameField.value.trim(),
      guest: guestsField.value.trim(),
      message: messageField.value.trim()
    };
    
    // Show loading state
    const submitButton = document.querySelector('input[type="submit"]');
    const originalText = submitButton.value;
    submitButton.value = 'Отправляем...';
    submitButton.disabled = true;
    
    try {
      // Send to Cloudflare Worker
      const response = await fetch('https://tima-wedding.xavescor.workers.dev', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show different messages based on attendance choice
        const defaultMessage = attendanceElement.value === 'yes' 
          ? 'Ответ отправлен! Спасибо за подтверждение!'
          : 'Зафиксировано что вы не придёте';
        alert(result.message || defaultMessage);
        formSubmitted = true; // Mark as submitted so no warning is shown
        saveSubmissionStatus(true); // Persist submission status to localStorage
        
        // Clear form fields
        nameField.value = '';
        guestsField.value = '';
        messageField.value = '';
        // Reset radio buttons
        document.querySelectorAll('input[name="attendance"]').forEach(radio => {
          radio.checked = false;
        });
        // Disable fields since no attendance is selected
        nameField.disabled = true;
        guestsField.disabled = true;
        messageField.disabled = true;
      } else {
        alert(result.error || 'Ошибка отправки. Попробуйте еще раз.');
      }
      
    } catch (error) {
      console.error('Error submitting form:', error);
      alert('Ошибка отправки. Проверьте интернет-соединение и попробуйте еще раз.');
    } finally {
      // Restore button state
      submitButton.value = originalText;
      submitButton.disabled = false;
    }
  }

  /************* Toggle form fields based on attendance choice ********************/
  function toggleFields() {
    const attendYes = document.getElementById('attendYes');
    const nameField = document.getElementById('nameField');
    const guestsField = document.getElementById('guestsField');
    const messageField = document.getElementById('messageField');

    if (attendYes.checked) {
      // Enable all fields when attending
      nameField.disabled = false;
      guestsField.disabled = false;
      messageField.disabled = false;
    } else {
      // Keep name field enabled when not attending
      nameField.disabled = false;
      guestsField.disabled = true;
      messageField.disabled = true;

      // Only clear non-essential fields
      guestsField.value = '';
      messageField.value = '';
    }
  }

  /************* Page close prevention ********************/
  window.addEventListener('beforeunload', function(event) {
    // Only show warning if form has data and hasn't been submitted
    if (!formSubmitted) {
      const message = 'Форма ещё не отправлена. Уверены что хотите уйти?';
      event.preventDefault();
      event.returnValue = message; // For older browsers
      return message;
    }
  });

  /************* Initialize page state ********************/
  document.addEventListener('DOMContentLoaded', function() {
    // Load submission status from localStorage
    formSubmitted = loadSubmissionStatus();
  });
</script>
</body>
</html>
